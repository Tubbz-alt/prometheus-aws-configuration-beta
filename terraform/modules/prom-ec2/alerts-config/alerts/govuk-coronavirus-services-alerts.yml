groups:
- name: GOVUK
  rules:
  - alert: GOVUK_CORONAVIRUS_SERVICES_RequestsExcess5xx
    expr: sum by(app) (rate(requests{org="govuk_development", space="production", status_range="5xx"}[5m])) / sum by(app) (rate(requests{org="govuk_development", space="production"}[5m])) >= 0.1
    for: 2m
    labels:
      product: "govuk-coronavirus-services"
    annotations:
      summary: "App {{ $labels.app }} has too many 5xx errors"
      description: "App {{ $labels.app }} has 5xx errors in excess of 10% of total requests"
      dashboard_url: https://grafana-paas.cloudapps.digital/d/N7NZbVrZz/coronavirus-form-services?refresh=1m&orgId=1
      runbook: "https://docs.publishing.service.gov.uk/manual/covid-19-services.html#monitoring"
      logs: "https://kibana.logit.io/s/04b46992-f653-4c14-965c-236e9a6c2777/app/kibana#/discover"
  - alert: GOVUK_CORONAVIRUS_SERVICES_HighCpuUsage
    expr: avg(cpu{org="govuk_development", app=~"govuk-coronavirus-.*", space="production"}) without (exported_instance) >= 80
    for: 5m
    labels:
        product: "govuk-coronavirus-services"
    annotations:
        summary: "App {{ $labels.app }} has high CPU usage"
        message: "Application {{ $labels.app }} has been using over 80% CPU (averaged over all instances) for 5 minutes or more"
        dashboard_url: https://grafana-paas.cloudapps.digital/d/N7NZbVrZz/coronavirus-form-services?refresh=1m&orgId=1
  - alert: GOVUK_CORONAVIRUS_SERVICES_HighDiskUsage
    expr: max(disk_utilization{org="govuk_development", app=~"govuk-coronavirus-.*", space="production"}) without (exported_instance) >= 80
    labels:
        product: "govuk-coronavirus-services"
    annotations:
        summary: "App {{ $labels.app }} has high disk usage"
        message: "Application {{ $labels.app }} has an instance which is using over 80% disk."
        dashboard_url: https://grafana-paas.cloudapps.digital/d/N7NZbVrZz/coronavirus-form-services?refresh=1m&orgId=1
  - alert: GOVUK_CORONAVIRUS_SERVICES_AlertDrill
    annotations:
      summary: Prometheus alert drill in progress...
      message: |
        This is an alert meant to ensure that the entire alerting pipeline is functional.
        This alert is always firing, therefore it should always be firing in Alertmanager
        and always fire against a receiver.
    expr: vector(1)
    labels:
        product: "govuk-coronavirus-services"
        severity: "warning"
